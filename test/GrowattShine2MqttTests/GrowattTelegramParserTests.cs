using GrowattShine2Mqtt;
using GrowattShine2Mqtt.Telegrams;
using Microsoft.Extensions.Logging;
using Moq;

namespace GrowattShine2MqttTests;

public class GrowattTelegramParserTests
{
    private readonly GrowattTelegramParser _sut;

    private readonly string _data3Example = "00250006024101030d222c402040467734257761747447726f7761747447726f7761747447723c27244c3676405f4750747447726f7761747447726f7761747447726f77777d7c544258756174743b726e5e29747447166f1346647447557f79712d35765c5f773b303506726a7760747447726fc361c0748f72a777612724024a2d4653444476636c82c6747547286f776174546752211216543129171d1018545467726e7970747440946f7e617c7454725e774174704a487e6973fa60597e1c6684658c526a6f7761747447726f7a5b656a54067ceb68b07fff7265776b747e47786f7361707447726f77617474566c6f7738353506425a4756444147726e466174744761f37749656a57bc61766f257453727b67367be4475a6f7761747447726f7761747747726ec3618b3a6772903941748b09526f882f54654487c86662657747726f77617477af760b77a9747447726f4560a27678726f77617671433e6dcb6538761f726f7761747447736f7761747447726f7761747447726f7761747447726f7761747447726f7761747447726f7761747447716f77617e744d720b7705747447726f1361107447726e7761747547726f7761747447726f7761747447726f7761757447726f7761747447726f7761747447726f7705747e47726f7761747447726f7761747447726f7761747447726f7761747447726f7761747447720b7705747447726f7761747447726f7761747447726f7761757447726f7761747447726f7761747447726f7761747447726f7761747447726f7760747447726f77617474477a18";
    private readonly string _data4Example = "00040006033f01040d222c402040467734257761747447726f7761747447726f7761747447723c27244c3676405f4750747447726f7761747447726f7761747447726f77777d7c54435d746174743b72697761747447726f7761747447726f7761747447726f7663717447726f7761747447726f7761747447726f7761747447726f7761747447726f7761747447726f7761747447726f776167fc48e66f71617467117d0877667474477260e761737447726f7761747447726f77614b7447732d776728e147726f5861747487726f7750747447b66f7761747447726f7761747447726f7761747447726f7761747447726f7761747447726f7761747447726f7761747447726f76e57545465a6e536174724d6b0b7761747447726f7761747447726f7761747447726f7761747447726f776a7474476b6f7761747447726e7761747447726f77617477af760b7767747447726f7761747467726f77617c7447726f7661747447746b776b74745a3e6f7761747447726f7761693847726f7761747447726f7761747447726f777c387447726f776174744772723b617474ba72696e3a748e47726f36617474cd726f77607474474e6f776154744772f97761745747726ff7617474dc726f7680747447726f7761747447726f7761747447726f7761747447726f7761747447726f776174744772eb7761747447786973617475717295771467e847726f616175742374c77761747447726f7761747447726f77617474477269df64fc78d67e14766e766c478f6f866076774e725f7762747a476a6f7761f47447760a7380747f47726f6e6174744771877761747447726f7761747447726f773a747446e66f77612e744773377761747447726f7761747427726e77617df947736f77658765b86390669e658b47726f7761747447726f7761747447726f4661747447726f7761747447726f7761747447726f7761747447726f7761747447726f7761747447726f7761747447726f7761747447726f7761747446726f7761747447726f7761747447726f7761747447726f7761747447726f7761747447726f7761747447726f7761747447726f7761747447726f7761747447726f7761747447726f7761747447726f7761747447726f7761747447726f7761747447726f53ab";

    public GrowattTelegramParserTests()
    {
        _sut = new GrowattTelegramParser(new Mock<ILogger<GrowattTelegramParser>>().Object);
    }

    [Fact]
    public void Test1()
    {
        var input = "309C236A6DB2265A4C807E70080045000050000A0000FE063641C0A804E4C0A800281658149F000019961656F70A501816D0AB96000000030006002001160D222C402040467734257761747447726F7761747447726F7761747447722142"
            .ParseHex();

        var result = _sut.Decrypt(input);


        var expected = "309c236a6db2265a0bf2110769743147723f776b7474b9745936a1dc70a3b2c77749622c53ed6f7778e262118565277962a4ece46f7761777441724f767779566b324f3727034062050e0315330628050e0315330628050e031533066630";

        Assert.Equal(expected, BitConverter.ToString(result.ToArray()).Replace("-", ""), ignoreCase: true);
    }

    [Fact]
    public void Data3Telegram()
    {
        var input = _data3Example
            .ParseHex();

        var result = _sut.ParseMessage(input);

        Assert.IsType<GrowattSPHData3Telegram>(result);
    }

    [Fact]
    public void Data4Telegram()
    {
        var input = _data4Example
            .ParseHex();

        var result = _sut.ParseMessage(input);

        Assert.IsType<GrowattSPHData4Telegram>(result);
        var dataTelegram = (result as GrowattSPHData4Telegram)!;
        Assert.Equal(6, dataTelegram.Pvstatus);
        Assert.Equal(10, dataTelegram.SOC);
        Assert.Equal(0, dataTelegram.Pv2current);
        Assert.Equal(1540, dataTelegram.Vbat);
    }

    [Fact]
    public void PingTelegram()
    {
        var input = "00020006002001160d222c402040467734257761747447726f7761747447726f776174744772b15e"
            .ParseHex();

        var result = _sut.ParseMessage(input);

        Assert.IsType<GrowattSPHPingTelegram>(result);
    }
}
