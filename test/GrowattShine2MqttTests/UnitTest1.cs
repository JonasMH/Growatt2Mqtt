using Castle.Core.Logging;
using GrowattShine2Mqtt;
using GrowattShine2Mqtt.Telegrams;
using Microsoft.Extensions.Logging;
using Moq;

namespace GrowattShine2MqttTests;

public class GrowattTelegramHeaderTests
	{
		[Fact]
		public void Test1()
		{
			var input = StringToByteArray("00300006033f0104");

			var result = GrowattTelegramHeader.Parse(input);

			Assert.Equal(831, result.MessageLength);
			Assert.Equal(GrowattTelegramType.DATA4, result.MessageType);
		}


		private byte[] StringToByteArray(string hex)
		{
			return Enumerable.Range(0, hex.Length)
							 .Where(x => x % 2 == 0)
							 .Select(x => Convert.ToByte(hex.Substring(x, 2), 16))
							 .ToArray();
		}
	}

	public class GrowattTelegramParserTests
	{
		private readonly GrowattTelegramParser _sut;

		public GrowattTelegramParserTests()
		{
			_sut = new GrowattTelegramParser(new Mock<ILogger<GrowattTelegramParser>>().Object);
		}

		[Fact]
		public void Test1()
		{
			var input = StringToByteArray("309C236A6DB2265A4C807E70080045000050000A0000FE063641C0A804E4C0A800281658149F000019961656F70A501816D0AB96000000030006002001160D222C402040467734257761747447726F7761747447726F7761747447722142");

			var result = _sut.Decrypt(input);


			var expected = "309c236a6db2265a0bf2110769743147723f776b7474b9745936a1dc70a3b2c77749622c53ed6f7778e262118565277962a4ece46f7761777441724f767779566b324f3727034062050e0315330628050e0315330628050e031533066630";

			Assert.Equal(expected, BitConverter.ToString(result.ToArray()).Replace("-", ""), ignoreCase: true);
		}

		[Fact]
		public void DataTelegram()
		{
			var input = StringToByteArray("00300006033f01040d222c402040467734257761747447726f7761747447726f7761747447723c27244c3676405f4750747447726f7761747447726f7761747447726f77777d73495466746174743b726a77617a004cd66f72617472ac79e97767747440d86f7663717447726f7761747447726f7761747447726f7761747447726f7761747447726f7761747447726f7761747447726f668467f748806f7f61746cf17dd37769747447726082617c7447726f7761747447726f776123744772857762531247726f4b617474ca726f775c747447fc6f7761747447726f7761747447726f7761747447726f7761747447726f7761747447726f7761747447726f7761747447726f767a752d46216e3c6174726c6b027761747447726f7761747447726f7761747447726f7761747447726f7764747447756f7761747447726e7761747447726f77617477af760b7764747447726f7761747447726f77617474477262db61747447744b7749747447726f7761747447726f7761747447726f7761747447726f7761747447726f777d547447726f776174744772735761747556726a6e02748e47726f6d61747458726f7760747447496f77615d744772317761745847726f2a617474ca726f779c747447726f7761747447726f7761747447726f7761747447726f7761747447726f776174744772ed77617474475a69539e50750172957768672247726f756175742374c77761747447726f7761747447726f77617474477269df64fc78887ea2744e757d46636e736076774e725f7762745c476a6f7761f47447760a7380747147726f706174744771877761747447726f7761747447726f7714747446686f776100744772b177616854477273576174743e726e776173f147736f7762d565b86390669e658b47726f7761747447726f7761747447726f4661747447726f7761747447726f7761747447726f7761747447726f7761747447726f7761747447726f7761747447726f7761747447726f7761747446726f7761747447726f7761747447726f7761747447726f7761747447726f7761747447726f7761747447726f7761747447726f7761747447726f7761747447726f7761747447726f7761747447726f7761747447726f7761747447726f7761747447726f84ac");

			var result = _sut.HandleMessage(input);

			Assert.IsType<GrowattSPHData4Telegram>(result);
		}

		[Fact]
		public void PingTelegram()
		{
			var input = StringToByteArray("00020006002001160d222c402040467734257761747447726f7761747447726f776174744772b15e");

			var result = _sut.HandleMessage(input);

			Assert.IsType<GrowattSPHPingTelegram>(result);
		}

		private byte[] StringToByteArray(string hex)
		{
			return Enumerable.Range(0, hex.Length)
							 .Where(x => x % 2 == 0)
							 .Select(x => Convert.ToByte(hex.Substring(x, 2), 16))
							 .ToArray();
		}
	}